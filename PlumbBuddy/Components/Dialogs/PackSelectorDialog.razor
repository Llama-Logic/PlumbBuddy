@inherits ReactiveComponentBase
@inject IDialogService DialogService
@inject IElectronicArtsApp ElectronicArtsApp
@inject IGameResourceCataloger GameResourceCataloger
@inject ILogger<PackSelectorDialog> Logger
@inject IMarkupLocalizer<AppText> MarkupLocalizer
@inject IModsDirectoryCataloger ModsDirectoryCataloger
@inject IPublicCatalogs PublicCatalogs
@inject ISettings Settings
@inject ISmartSimObserver SmartSimObserver
@inject ISteam Steam
@inject IStringLocalizer<AppText> StringLocalizer

<MudDialog Class="primary-dialog">
    <TitleContent>
        <MudStack Row="true">
            <MudIcon Icon="@MaterialDesignIcons.Normal.BagPersonalTag" Color="Color.Primary" />
            <MudTextM3 Typo="TypoM3.Title" Color="Color.Primary">
                @MarkupLocalizer[nameof(AppText.PackSelectorDialog_Caption)]
            </MudTextM3>
        </MudStack>
    </TitleContent>
    <DialogContent>
        <MudAlert Severity="Severity.Warning">
            <MudMarkdown Value="@(AppText.PackSelectorDialog_EUA)" />
        </MudAlert>
        @if (isLoading)
        {
            <MudProgressLinear Color="Color.Info" Indeterminate />
            <MudAlert Icon="@MaterialDesignIcons.Outline.FolderMultiple" Severity="Severity.Info">
                <MudMarkdown Value="@(AppText.PackSelectorDialog_Status_Examining)" />
            </MudAlert>
        }
        @if (isApplying)
        {
            <MudProgressLinear Color="Color.Success" Indeterminate />
            <MudAlert Icon="@MaterialDesignIcons.Outline.ContentSaveCog" Severity="Severity.Success">
                <MudMarkdown Value="@(AppText.PackSelectorDialog_Status_Applying)" />
            </MudAlert>
        }
        @if (PackGroups.Count is > 0)
        {
            <MudGrid Justify="Justify.Center" Spacing="2">
                <MudItem>
                    <MudCheckBox T="bool?" Color="Color.Primary" Disabled="@isApplying" TriState Value="@AllPacks" ValueChanged="@((Action<bool?>)(isChecked => AllGroupsValueChangedHandler(isChecked)))">
                        <MudMarkdown Value="@string.Format(new CultureInfo("en-US"), Settings.ShowDlcRetailUsd && PublicCatalogs.PackCatalog is not null ? "{0} ({1:c})" : "{0}", StringLocalizer[nameof(AppText.PackSelectorDialog_SelectAll), AppText.PackSelectorDialog_SelectAll_Global], PackGroups.Sum(pg => pg.TotalRetailUsd))" />
                    </MudCheckBox>
                </MudItem>
            </MudGrid>
        }
        @foreach(var packGroup in PackGroups)
        {
            <MudTextM3 Align="Align.Center" Class="mt-8" Typo="TypoM3.Title">
                @packGroup.Name
            </MudTextM3>
            @if (packGroup.Packs.Count is > 1)
            {
                <MudGrid Justify="Justify.Center" Spacing="2">
                    <MudItem>
                        <MudCheckBox T="bool?" Color="Color.Primary" Disabled="@isApplying" TriState Value="@packGroup.IsChecked" ValueChanged="@((Action<bool?>)(isChecked => GroupValueChangedHandler(packGroup, isChecked)))">
                            <MudMarkdown Value="@string.Format(new CultureInfo("en-US"), Settings.ShowDlcRetailUsd && PublicCatalogs.PackCatalog is not null ? "{0} ({1:c})" : "{0}", StringLocalizer[nameof(AppText.PackSelectorDialog_SelectAll), @packGroup.Name], packGroup.TotalRetailUsd)" />
                        </MudCheckBox>
                    </MudItem>
                </MudGrid>
            }
            <MudGrid Spacing="2">
                @foreach (var pack in packGroup.Packs)
                {
                    <MudItem xs="12" md="@(UsePublicPackCatalog ? 4 : 3)">
                        <MudSwitchM3 Color="Color.Primary" Disabled="@isApplying" ThumbIcon="@MaterialDesignIcons.Normal.BagPersonal" ThumbOffIcon="@MaterialDesignIcons.Normal.BagPersonalOff" Value="@pack.IsChecked" ValueChanged="@((Action<bool>)(isChecked => ValueChangedHandler(pack.Code, isChecked)))">
                            <MudStack AlignItems="AlignItems.Center" Class="ga-1" Row>
                                <MudImage Height="32" Src="@pack.Icon" Width="32" />
                                @pack.Name
                            </MudStack>
                        </MudSwitchM3>
                    </MudItem>
                }
            </MudGrid>
        }
    </DialogContent>
    <DialogActions>
        <MudGrid Spacing="1" Class="align-center">
            @if (!isLoading && Settings.ShowDlcRetailUsd && PublicCatalogs.PackCatalog is not null)
            {
                <MudItem>
                    <MudChip T="string" Class="mx-0" Color="Color.Success" Icon="@MaterialDesignIcons.Normal.CurrencyUsd" Text="@string.Format(new CultureInfo("en-US"), AppText.PackSelectorDialog_TotalEnabledContent_Label, EnabledDlcTotalRetailUsd)" Style="@(EnabledDlcTotalRetailUsd is 0 ? "opacity: .2;" : string.Empty)" />
                </MudItem>
                <MudItem Class="flex-grow-1">
                    <MudProgressLinear Color="Color.Success" Size="Size.Large" Rounded Striped Max="@((double)EnabledDlcTotalRetailUsd + (double)DisabledDlcTotalRetailUsd)" Value="@((double)EnabledDlcTotalRetailUsd)" />
                </MudItem>
                <MudItem>
                    <MudChip T="string" Class="mx-0" Color="Color.Warning" Icon="@MaterialDesignIcons.Normal.CurrencyUsdOff" Text="@string.Format(new CultureInfo("en-US"), AppText.PackSelectorDialog_TotalDisabledContent_Label, DisabledDlcTotalRetailUsd)" Style="@(DisabledDlcTotalRetailUsd is 0 ? "opacity: .2;" : string.Empty)" />
                </MudItem>
                <MudFlexBreak />
            }
            <MudItem>
                <MudTooltip Text="@(AppText.PackSelectorDialog_UsePublicPackCatalog_Tip)" Color="Color.Primary" Placement="Placement.Top" Arrow>
                    <MudSwitchM3 @bind-Value="@UsePublicPackCatalog" Disabled="@(isLoading || isApplying)" Label="@(AppText.PackSelectorDialog_UsePublicPackCatalog_Label)" Color="Color.Primary" ThumbIcon="@MaterialDesignIcons.Normal.CloudSync" ThumbOffIcon="@MaterialDesignIcons.Outline.CloudOff" />
                </MudTooltip>
            </MudItem>
            <MudSpacer />
            <MudItem>
                <MudTooltip Arrow Text="@(AppText.Tooltip_GuideLink)" Color="Color.Info" Placement="Placement.Top">
                    <MudIconButton Icon="@MaterialDesignIcons.Outline.HelpCircle" Color="Color.Info" Href="@($"https://plumbbuddy.app/redirect?to=PlumbBuddyInAppGuidePackSelector{Settings.Type}")" />
                </MudTooltip>
            </MudItem>
            <MudItem>
                <MudButton Disabled="@isApplying" OnClick="CancelOnClickHandler">
                    @MarkupLocalizer[nameof(AppText.Common_Cancel)]
                </MudButton>
            </MudItem>
            @{
                var okTip = AppText.PackSelectorDialog_Ok_Tip;
                if (isLoading)
                    okTip = AppText.PackSelectorDialog_Ok_Tip_Loading;
                else if (isApplying)
                    okTip = AppText.PackSelectorDialog_Ok_Tip_Applying;
                else if (ModsDirectoryCataloger.State is ModsDirectoryCatalogerState.Sleeping)
                    okTip = AppText.PackSelectorDialog_Ok_Tip_GameIsRunning;
            }
            <MudItem>
                <MudTooltip Arrow Color="Color.Primary" Placement="Placement.Top" Text="@okTip">
                    <MudButton Color="Color.Primary" Disabled="@(isLoading || isApplying || ModsDirectoryCataloger.State is ModsDirectoryCatalogerState.Sleeping)" OnClick="OkOnClickHandlerAsync">
                        @MarkupLocalizer[nameof(AppText.Common_Ok)]
                    </MudButton>
                </MudTooltip>
            </MudItem>
        </MudGrid>
    </DialogActions>
</MudDialog>
